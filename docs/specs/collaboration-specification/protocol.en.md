# Protocol Definition

**Document Version**: 1.0  
**Software Version**: 0.1.0  
**Last Updated**: 2026-01-14

---

## Signaling Message Types

### 1. Room Registration (Host → Server)

```typescript
interface RegisterRoomRequest {
  hostId: string;          // Host unique ID (UUID)
  metadata?: {
    hostName?: string;
    maxParticipants?: number;  // Default: 4
  };
}

interface RegisterRoomResponse {
  success: boolean;
  roomCode: string;        // 4-digit number generated by server (0000-9999)
  hostId: string;
  expiresAt: number;       // Room expiration time (milliseconds, 6 hours later)
  allowJoin: boolean;      // Join permission status (initial: false)
}
```

**Note:** Room code is generated and returned by the server. Clients do not generate room codes.

### 2. Room Query (Participant → Server)

```typescript
interface GetRoomRequest {
  roomCode: string;
}

interface GetRoomResponse {
  success: boolean;
  room?: {
    roomCode: string;
    hostId: string;
    status: 'active' | 'inactive' | 'full';
    allowJoin: boolean;           // Join permission status
    allowJoinExpiresAt?: number;  // Join permission expiration time
    participantCount: number;
    maxParticipants: number;
    createdAt: number;
    expiresAt: number;            // Room expiration time (6 hours later)
  };
  error?: string;
}
```

### 3. WebRTC Signaling Messages

```typescript
interface SignalingMessage {
  type: 'offer' | 'answer' | 'ice-candidate';
  from: string;            // Sender ID
  to: string;              // Receiver ID (host or participant)
  roomCode: string;
  data: {
    // WebRTC offer/answer
    sdp?: RTCSessionDescriptionInit;
    // ICE candidate
    candidate?: RTCIceCandidateInit;
  };
  timestamp: number;
}
```

### 4. P2P Data Messages (WebRTC DataChannel)

```typescript
interface P2PMessage {
  type: 'initial-state' | 'state-request' | 'change' | 'transport' | 'ping' | 'pong' | 'error';
  from: string;
  to?: string;
  timestamp: number;
  data?: any;
}

// Initial state (Host → Guest)
interface InitialStateMessage extends P2PMessage {
  type: 'initial-state';
  data: {
    projectState: ProjectState; // Complete project state
    isInitial: boolean;
  };
}

// State request (Guest → Host)
interface StateRequestMessage extends P2PMessage {
  type: 'state-request';
}

// Change propagation
interface ChangeMessage extends P2PMessage {
  type: 'change';
  data: {
    change: RemoteChange;
    sequence?: number;
  };
}

interface RemoteChange {
  type:
    | 'channel-volume'
    | 'channel-pan'
    | 'channel-effect'
    | 'master-volume'
    | 'master-pan'
    | 'master-effect'
    | 'midi-part'
    | 'midi-note'
    | 'time-signature'
    | 'bpm';
  trackId?: string;
  partId?: string;
  noteId?: string;
  value: any;
  timestamp: number;
  clientId: string;
}

// Transport sync
interface TransportMessage extends P2PMessage {
  type: 'transport';
  data: {
    action: 'play' | 'pause' | 'stop' | 'seek';
    time: number; // seconds
  };
}
```

**Notes:**
- Initial state is requested by the guest after the DataChannel opens (`state-request`), then the host responds with `initial-state`.
- Timing sync uses only the first tempo/time signature event (tick 0), not the entire map.
- Master sync currently includes pan/effects; master volume is defined but not emitted.

---

